<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moon Phase Life Compass ‚Äî v0.1</title>
  <!-- Tailwind via CDN for fast prototyping -->
  <script src="https://cdn.tailwindcss.com"></script>
  
    <style>
    
        .phase-title { text-align:center; }
        .phase-title .kicker { font-size:.85rem; letter-spacing:.08em; text-transform:uppercase; opacity:.85; }
        .phase-title .rule { width:72px; height:2px; margin:.35rem auto .5rem; background:rgba(231,238,255,.35); border-radius:999px; }
        .phase-title .big { font-size:1.25rem; line-height:1.1; font-weight:600; }

    
        /* Highlight the section that matches the current phase */
        .is-current {
          outline: 2px solid rgba(139,184,255,.55);
          box-shadow:
            inset 0 0 24px rgba(139,184,255,.18),
            0 0 28px rgba(139,184,255,.12);
        }
        
        .phase-badge {
          display: inline-block;
          margin-left: .6rem;
          padding: .2rem .5rem;
          border-radius: .5rem;
          background: rgba(139,184,255,.18);
          border: 1px solid rgba(139,184,255,.35);
          font-size: .75rem;
          color: var(--ink);
        }

        .phase-ring {
          --ring-rot: 0deg;
          position: relative; width: 300px; height: 300px; margin: 0 auto;
          border-radius: 9999px;
          background: radial-gradient(60% 60% at 50% 50%, rgba(139,184,255,.18), transparent 70%);
          box-shadow: inset 0 0 30px rgba(139,184,255,.18);
          transform: rotate(var(--ring-rot));
        }
        .phase-ring .dot { position:absolute; transform:translate(-50%,-50%) rotate(calc(-1 * var(--ring-rot))); }
        .phase-ring .node {
          display:flex; align-items:center; gap:.5rem;
          padding:.5rem .8rem; border-radius:9999px;
          background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2);
          backdrop-filter: blur(6px); font-size:.85rem;
        }
        .phase-ring .pip {
          width:.6rem; height:.6rem; border-radius:9999px;
          background:linear-gradient(#fff, #9fb6ff);
          box-shadow:0 0 10px rgba(139,184,255,.65);
        }

        .phase-ring { position: relative; width: 260px; height: 260px; margin: 0 auto; }
        .phase-ring .dot { position: absolute; transform: translate(-50%, -50%); }
        .phase-ring button {
          background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.2);
          color: var(--ink); padding: .5rem .75rem; border-radius: 9999px; font-size: .8rem;
          backdrop-filter: blur(6px);
        }

      /* ===== Night-sky App Theme ===== */
      :root{
        --ink:#e8ecf7;            /* primary text (near-white) */
        --muted:#c7d0e6;          /* secondary text */
        --paper: #0a0f1d;         /* deepest backdrop overlay */
        --glass: rgba(8,12,24,.55); /* card background (glass) */
        --glass-border: rgba(173,197,255,.15);
        --chip-border: rgba(231,238,255,.25);
        --accent:#8bb8ff;         /* moonlight blue */
      }
    
      /* Background image (no 'fixed' for iOS perf) */
      html,body{height:100%}
      body{
        color:var(--ink);
        background:
          radial-gradient(1200px 800px at 70% -10%, rgba(150,120,220,.15), transparent 55%),
          radial-gradient(1000px 700px at 20% 110%, rgba(120,160,255,.12), transparent 45%),
          #000 url("starry-bg.png") center/cover no-repeat;
        -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
      }
    
      .watercolor{filter:saturate(1.05) contrast(1.04)}
      .card{
        background: var(--glass);
        backdrop-filter: blur(8px) saturate(1.05);
        -webkit-backdrop-filter: blur(8px) saturate(1.05);
        border: 1px solid var(--glass-border);
      }
      .moon-glow{
        box-shadow:
          0 0 30px rgba(255,255,255,.6),
          0 0 80px rgba(139,184,255,.25);
      }
      .chip{
        border:1px dashed var(--chip-border);
        color: var(--ink);
      }
    
      /* Make all those Tailwind slate text utilities readable on dark bg */
      .text-slate-500, .text-slate-600, .text-slate-700 { color: var(--muted) !important; }
      .text-slate-400 { color: rgba(255,255,255,.7) !important; }
      .text-slate-300 { color: rgba(255,255,255,.8) !important; }
    
      /* Inputs / textareas / buttons in dark mode */
      input[type="text"], input[type="search"], input:not([type]), textarea {
        background: rgba(255,255,255,.06);
        color: var(--ink);
        border: 1px solid rgba(255,255,255,.18);
      }
      input::placeholder, textarea::placeholder { color: rgba(255,255,255,.55); }
      button.bg-slate-900{ background:#0b1226 !important; }
      button.bg-slate-900:hover{ background:#0e1630 !important; }
      .border-slate-200{ border-color: rgba(255,255,255,.18) !important; }
    
      /* Moon canvas rim */
      #moonCanvas{ background:#0b1324; border:1px solid rgba(255,255,255,.15); }
 
     /* PNG moon art + soft white glow */
    .moon-art{
      width: 7rem;              /* same visual size as your old w-28 */
      height: 7rem;
      display:block;
      border-radius:9999px;     /* keeps the glow circular */
      object-fit: cover;
      filter:
        drop-shadow(0 0 10px rgba(255,255,255,.85))
        drop-shadow(0 0 36px rgba(139,184,255,.35));
      /* optional: faint edge ring to blend transparencies */
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.12),
        0 0 60px rgba(139,184,255,.20);
      background: transparent;
    }
       
    /* Word cloud container */
    #cloud{
      display:flex; flex-wrap:wrap; justify-content:center; align-items:center;
      gap:.45rem .6rem; padding:12px 8px; min-height:120px;
    }
    
    /* Word chip */
    #cloud .w{
      display:inline-block; line-height:1;
      padding:.18rem .42rem; border-radius:.65rem;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 10px rgba(139,184,255,.10), 0 0 6px rgba(139,184,255,.08);
      color: var(--ink);
      /* subtle glow on hover */
      transition: transform .12s ease, box-shadow .12s ease;
    }
    #cloud .w:hover{
      transform: translateY(-1px);
      box-shadow: inset 0 0 14px rgba(139,184,255,.18), 0 0 10px rgba(139,184,255,.12);
    }

    /* Word styles ‚Äì three tiers */
    #cosmic-bg .t{
      position:absolute; white-space:nowrap; user-select:none;
      color: rgba(255,255,255,.15);
      text-shadow:
        0 0 14px rgba(150,190,255,.20),
        0 0 28px rgba(120,160,255,.14);
      letter-spacing:.02em;
    }
    #cosmic-bg .A{ font-weight:700; opacity:.18; }   /* purposes */
    #cosmic-bg .B{ font-weight:600; opacity:.14; }   /* goals */
    #cosmic-bg .C{ font-weight:500; opacity:.10; }   /* journal words */
    
    /* gentle twinkle on background words */
    @keyframes slowTwinkle { 0%{opacity:.7} 50%{opacity:1} 100%{opacity:.7} }
    #cosmic-bg .t { animation: slowTwinkle 9s ease-in-out infinite; }
    #cosmic-bg .t:nth-child(3n){ animation-duration: 11s }
    #cosmic-bg .t:nth-child(4n){ animation-duration: 13s }
    
    /* responsive size ranges */
    @media (min-width: 900px){
      #cosmic-bg .A{ font-size: clamp(36px, 8vw, 84px); }
      #cosmic-bg .B{ font-size: clamp(20px, 4.5vw, 40px); }
      #cosmic-bg .C{ font-size: clamp(12px, 2.6vw, 20px); }
    }
    @media (max-width: 899px){
      #cosmic-bg .A{ font-size: clamp(28px, 9vw, 56px); }
      #cosmic-bg .B{ font-size: clamp(16px, 5.5vw, 30px); }
      #cosmic-bg .C{ font-size: clamp(10px, 3.5vw, 16px); }
    }


    /* Word-cloud stage */
    #cloud{
      position: relative;
      height: 420px;                /* adjust if you want taller */
      overflow: hidden;
      border-radius: 1rem;
      background:
        radial-gradient(120% 90% at 70% 10%, rgba(164,122,244,.22), transparent 50%),
        radial-gradient(100% 80% at 30% 80%, rgba(80,180,255,.18), transparent 55%),
        radial-gradient(120% 100% at 50% 40%, rgba(255,160,220,.12), transparent 60%),
        #081224;                    /* deep night */
      box-shadow:
        inset 0 0 80px rgba(139,184,255,.18),
        inset 0 -60px 120px rgba(20,30,60,.55);
    }
    

   
    /* Twinkling stars */
    #cloud::before, #cloud::after{
      content:"";
      position:absolute; inset:0;
      background-repeat: repeat;
      pointer-events:none;
    }
    #cloud::before{                        /* small stars */
      background-image: radial-gradient(2px 2px at 20px 40px,#fff,transparent),
                        radial-gradient(1px 1px at 130px 90px,#bcd8ff,transparent),
                        radial-gradient(1px 1px at 240px 20px,#fff,transparent),
                        radial-gradient(2px 2px at 380px 140px,#e5f0ff,transparent);
      opacity:.9; filter: blur(.2px);
      animation: twinkle 8s linear infinite;
    }
    #cloud::after{                         /* faint star dust */
      background-image: radial-gradient(1.2px 1.2px at 80px 160px,#fff,transparent),
                        radial-gradient(1px 1px at 260px 220px,#d8ecff,transparent),
                        radial-gradient(1.3px 1.3px at 420px 60px,#fff,transparent),
                        radial-gradient(1px 1px at 560px 180px,#c6dbff,transparent);
      opacity:.6; filter: blur(.3px);
      animation: twinkle 10s linear infinite reverse;
    }
    @keyframes twinkle{
      0%{opacity:.55} 50%{opacity:1} 100%{opacity:.55}
    }
    
    /* Each word */
    #cloud .wc{
      position:absolute;
      white-space:nowrap;
      transform: translate(-50%, -50%);
      text-shadow:
        0 0 10px rgba(155,190,255,.25),
        0 0 22px rgba(130,170,255,.18);
      user-select:none;
    }

    
      /* Header tweaks */
      header .w-12.h-12{ background: radial-gradient(120% 120% at 20% 20%, #ffffff, #9fb6ff 45%, #4c5c9e 85%); }
        
        
        /* Simple pages */
        .page{ display:none; }
        .page.active{ display:block; }
        
        /* Back button */
        .back-btn{
          display:inline-flex; align-items:center; gap:.5rem;
          padding:.4rem .75rem; border-radius:9999px;
          border:1px solid rgba(255,255,255,.2);
          background:rgba(255,255,255,.06);
        }
        .back-btn:hover{ background:rgba(255,255,255,.1); }
        
        
        .map-water   { fill:#0e1830; }                             /* slightly lighter water */
        .map-land    { fill:rgba(255,255,255,.14); }               /* brighter land tint    */
        .map-lines   { stroke:rgba(231,238,255,.28); stroke-width:.6; fill:none; }
        .map-border  { stroke:rgba(231,238,255,.45); stroke-width:.8; fill:none; }
        .map-country { stroke:rgba(231,238,255,.32); stroke-width:.45; fill:none; }
        
        /* region overlays a touch stronger */
        .map-region       { fill-opacity:.18; stroke-width:.9; stroke:rgba(255,255,255,.30); 
                            filter: drop-shadow(0 1px 6px rgba(139,184,255,.08)); }
        .map-region:hover { fill-opacity:.34; }
        .map-hit          { fill:transparent; cursor:pointer; }

        /* --- Phase 4: Loom-of-stars background --- */
        #page-phase-4 { position: relative; overflow: clip; }
        #loomBG{
          position:absolute; inset:0;
          z-index:0;                /* keeps it behind your cards */
          pointer-events:none;
          opacity: .9;              /* overall softness */
        }
        .phase4-foreground { position: relative; z-index:1; } /* add to your content wrapper if needed */
        
        /* optional: slightly tighten the card contrast on this page */
        #page-phase-4 .card{ box-shadow: inset 0 0 60px rgba(139,184,255,.10); }
        
    </style>

</head>
<body class="min-h-screen">
    <div id="cosmic-bg" aria-hidden="true"></div>
  <header class="p-6 md:p-10">
    <div class="max-w-5xl mx-auto flex items-center gap-4">
      <div class="w-12 h-12 rounded-full bg-gradient-to-br from-slate-200 to-white moon-glow"></div>
      <div>
        <h1 class="text-2xl md:text-3xl font-semibold">Moon Phase Life Compass</h1>
        <p class="text-sm text-slate-500">v0.1 prototype ‚Äî single file (HTML/CSS/JS). Local-first. Supabase-ready.</p>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto p-6 md:p-10 grid gap-8">

    <!-- ============== HOME (Main Menu) ============== -->
    <section id="page-home" class="page active">
    <!-- STATUS BAR -->
    <section id="status" class="card rounded-2xl p-6 shadow">
      <div class="flex flex-col md:flex-row md:items-center gap-6 md:gap-10">
        <div class="shrink-0 relative">
          <img id="moonArt" alt="Moon phase" class="moon-art" src="assets/moon1.png">
          <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 text-xs text-slate-500">Today</div>
        </div>
        <div class="grid gap-2">
          <div class="text-sm text-slate-500">
            Date & time: <span id="todayStr"></span> ‚Ä¢ Timezone: <span id="tzStr"></span>
          </div>
    
          <div class="text-xl font-semibold">
            Current phase: <span id="phaseName">‚Äî</span>
            <span class="text-slate-500 text-sm">(<span id="illumPct">‚Äî</span> illuminated)</span>
          </div>
    
          <div class="text-sm text-slate-600">Monthly Stage: <span id="lifeStage" class="font-medium">‚Äî</span></div>
          <div class="text-sm text-slate-600">My Purpose: <span id="myPurpose">‚Äî</span></div>
          <div class="text-sm text-slate-600">Next phase: <span id="nextEvent">‚Äî</span></div>
        </div>
    
        <div class="md:ml-auto">
          <button class="chip rounded-xl px-3 py-2 text-sm" onclick="alert('Picker coming soon ‚ú®')">
            Change Indigenous Moon Tradition
          </button>
        </div>
      </div>
    </section>

    
      <!-- PHASE NAV CIRCLE -->
      <section class="card rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold mb-4 text-center">Cycle Navigator</h2>
        <div class="phase-ring">
          <!-- TOP = Phase 2 -->
          <div class="dot" style="left:50%; top:6%;">
            <button class="node" onclick="goPhase(2)">
              <span class="pip"></span>
              <div class="flex flex-col items-start">
                <span class="text-xs uppercase tracking-wide opacity-80">Phase 2</span>
                <span class="font-medium">Advance Purpose</span>
              </div>
            </button>
          </div>
        
          <!-- RIGHT = Phase 3 -->
          <div class="dot" style="left:94%; top:50%;">
            <button class="node" onclick="goPhase(3)">
              <span class="pip"></span>
              <div class="flex flex-col items-start">
                <span class="text-xs uppercase tracking-wide opacity-80">Phase 3</span>
                <span class="font-medium">Give Thanks</span>
              </div>
            </button>
          </div>
        
          <!-- BOTTOM = Phase 4 -->
          <div class="dot" style="left:50%; top:94%;">
            <button class="node" onclick="goPhase(4)">
              <span class="pip"></span>
              <div class="flex flex-col items-start">
                <span class="text-xs uppercase tracking-wide opacity-80">Phase 4</span>
                <span class="font-medium">Recapitulate</span>
              </div>
            </button>
          </div>
        
          <!-- LEFT = Phase 1 -->
          <div class="dot" style="left:6%; top:50%;">
            <button class="node" onclick="goPhase(1)">
              <span class="pip"></span>
              <div class="flex flex-col items-start">
                <span class="text-xs uppercase tracking-wide opacity-80">Phase 1</span>
                <span class="font-medium">Wait for Purpose</span>
              </div>
            </button>
          </div>
        </div>

        <p class="text-center text-slate-500 mt-4 text-sm">
          Current phase is pinned to the north; tap a button to open that page.
        </p>
      </section>
      
        <!-- GLOBAL TRADITIONS MAP -->
        <section class="card rounded-2xl p-6 shadow">
          <h2 class="text-lg font-semibold mb-4 text-center">
            Explore Global Indigenous Moon Traditions
          </h2>
        
          <div class="text-center text-slate-500 text-sm mb-2">
            Gall‚ÄìPeters equal-area base ‚Ä¢ Regions are rough placeholders you can refine
          </div>
        
          <div class="relative">
            <svg id="worldMap" class="w-full" style="height: 420px;"></svg>
        
            <!-- Simple legend -->
            <div class="absolute right-3 bottom-3 bg-black/25 backdrop-blur-sm
                border border-white/15 rounded-xl p-3 text-xs">
                <div class="font-semibold mb-1">
                  Regions (<span id="regionCount"></span>)
                </div>
              <ul id="regionLegend" class="space-y-1"></ul>
            </div>
          </div>
        </section>
    </section>



    <!-- ============== PHASE 1 PAGE ============== -->
    <section id="page-phase-1" class="page">
      <button class="back-btn mb-4" onclick="goHome()">‚Üê Back to Main Menu</button>
    
      <div class="phase-title mb-4">
        <div class="kicker">Phase 1</div>
        <div class="rule"></div>
        <div class="big">Wait for Purpose</div>
      </div>
    
      <section class="card rounded-2xl p-6 shadow" data-phase="1">
            <h2 class="text-xl font-semibold">
              Phase 1 ‚Äî New Moon ‚Üí Wait for Purpose
              <span class="phase-badge" data-phase-badge="1" style="display:none">CURRENT</span>
            </h2>
    
          <p class="text-sm text-slate-600">Quietly name what‚Äôs stirring. Your text never leaves this device unless you later enable cloud sync.</p>
          <textarea id="journalInput" rows="5" placeholder="What purpose or direction is stirring?" class="mt-3 w-full p-3 rounded-xl border border-slate-200"></textarea>
            <div class="flex items-center gap-3 mt-3">
              <button class="bg-slate-900 text-white px-4 py-2 rounded-xl" onclick="submitEntry()">Submit Entry</button>
              <button class="px-3 py-2 rounded-xl chip" onclick="refreshCurrentCycleUI()">Build Word Cloud</button>
              <button class="px-3 py-2 rounded-xl chip" onclick="exportCurrentCycle()">Export Cycle</button>
              <button class="px-3 py-2 rounded-xl chip" onclick="goHistory()">History</button>
              <span id="journalSaved" class="text-sm text-slate-500"></span>
            </div>
            
            <!-- entries feed -->
            <div id="entryList" class="mt-4 space-y-2 max-h-64 overflow-auto"></div>
            
            <div id="cloud" class="cloud mt-4"></div>
        </section>
    </section>
    
    
    <!-- ============== PHASE 2 PAGE ============== -->
    <section id="page-phase-2" class="page">
      <button class="back-btn mb-4" onclick="goHome()">‚Üê Back to Main Menu</button>
    
      <div class="phase-title mb-4">
        <div class="kicker">Phase 2</div>
        <div class="rule"></div>
        <div class="big">Advance Purpose</div>
      </div>
    
      <section class="card rounded-2xl p-6 shadow" data-phase="2">
        <h2 class="text-xl font-semibold">
          Phase 2 ‚Äî Waxing ‚Üí Advance Your Purpose
          <span class="phase-badge" data-phase-badge="2" style="display:none">CURRENT</span>
        </h2>
    
        <!-- PURPOSES (1‚Äì5) -->
        <div class="mt-3">
          <label class="text-sm text-slate-500 block mb-2">What are your main purposes for this cycle?</label>
    
          <ul id="purposeList" class="space-y-2"></ul>
    
          <div class="flex gap-2 mt-3">
            <input id="purposeInput" class="flex-1 p-3 rounded-xl border border-slate-200" placeholder="Add a purpose (max 5)..." />
            <button class="bg-slate-900 text-white px-4 py-2 rounded-xl" onclick="addPurpose()">Add</button>
          </div>
    
          <div class="text-xs text-slate-500 mt-2">Tip: these appear as ‚ÄúMy Purpose‚Äù at the top of Home.</div>
        </div>
    
        <hr class="my-5 border-white/15">
    
        <!-- TASK CHECKLIST (persists across cycles until deleted) -->
        <h3 class="text-lg font-semibold">Task Checklist</h3>
        <div class="flex gap-2 mt-3">
          <input id="taskInput" class="flex-1 p-3 rounded-xl border border-slate-200" placeholder="Add a task..." />
          <button class="bg-slate-900 text-white px-4 py-2 rounded-xl" onclick="taskAddFromInput()">Add</button>
        </div>

    
        <div class="flex gap-2 mt-2">
          <button class="px-4 py-2 rounded-xl chip" onclick="taskArchiveCompleted()">Archive Completed</button>
          <button class="px-4 py-2 rounded-xl chip" onclick="taskClearAll()">Clear All</button>
        </div>
    
        <h4 class="text-md font-medium mt-5">Current Tasks</h4>
        <ul id="taskList" class="mt-3 space-y-2"></ul>
    
        <div class="text-xs text-slate-500 mt-4">
          Notes: Tasks carry forward into each new cycle until you delete them. ‚ÄúArchive‚Äù keeps a month-by-month history of everything you added or completed.
        </div>
      </section>
    </section>

    
    <!-- ============== PHASE 3 PAGE ============== -->
    <section id="page-phase-3" class="page">
      <button class="back-btn mb-4" onclick="goHome()">‚Üê Back to Main Menu</button>
    
      <div class="phase-title mb-4">
        <div class="kicker">Phase 3</div>
        <div class="rule"></div>
        <div class="big">Give Thanks</div>
      </div>
    
      <section class="card rounded-2xl p-6 shadow" data-phase="3">
            <h2 class="text-xl font-semibold">
              Phase 3 ‚Äî Full Moon ‚Üí Celebrate & Give Thanks
              <span class="phase-badge" data-phase-badge="3" style="display:none">CURRENT</span>
            </h2>
    
          <div class="p-4 rounded-xl bg-gradient-to-r from-amber-50 to-emerald-50 border border-amber-200">
            <p class="text-slate-700">This week is for gratitude, rest, and joy. Consider going screen‚Äëfree. If you check the app, it will simply remind you to go live your life.</p>
            <button class="mt-3 px-4 py-2 rounded-xl chip" onclick="ackCelebrate()">I‚Äôll step away üíõ</button>
            <span id="celebrateAck" class="text-sm text-slate-500 ml-2"></span>
          </div>
        </section>
    </section>
    
    <!-- ============== PHASE 4 PAGE ============== -->
    <section id="page-phase-4" class="page">
      <button class="back-btn mb-4" onclick="goHome()">‚Üê Back to Main Menu</button>
      
      <!-- Phase 4 background -->
      <div id="loomBG" aria-hidden="true"></div>

      <div class="phase-title mb-4">
        <div class="kicker">Phase 4</div>
        <div class="rule"></div>
        <div class="big">Recapitulate</div>
      </div>
    
      <section class="card rounded-2xl p-6 shadow" data-phase="4">
            <h2 class="text-xl font-semibold">
              Phase 4 ‚Äî Waning ‚Üí Recapitulation & Loose Ends
              <span class="phase-badge" data-phase-badge="4" style="display:none">CURRENT</span>
            </h2>
    
          <p class="text-sm text-slate-600">After a courageous week of movement and a centering week of gratitude, this is the weaving week. Gather the loose threads you dropped, prune the branches that no longer serve, re-stitch what matters, and offer thanks as you move toward rest and renewal.</p>
    
          <div class="mt-3">
            <h3 class="font-medium">Carry Over from Phase 2</h3>
            <ul id="carryOver" class="mt-2 space-y-2"></ul>
            <button class="mt-2 px-4 py-2 rounded-xl chip" onclick="carrySelected()">Add Selected to Next Cycle</button>
          </div>
    
          <div class="mt-6">
            <h3 class="font-medium">Loose End Tracker</h3>
            <div class="flex gap-2 mt-2">
              <input id="looseInput" class="flex-1 p-3 rounded-xl border border-slate-200" placeholder="Add a loose end (e.g., email Dr. G.)" />
              <button class="bg-slate-900 text-white px-4 py-2 rounded-xl" onclick="addLoose()">Add</button>
            </div>
            <ul id="looseList" class="mt-3 space-y-2"></ul>
            <div class="flex gap-2 mt-2">
              <button class="px-4 py-2 rounded-xl chip" onclick="archiveLoose()">Archive Completed</button>
              <button class="px-4 py-2 rounded-xl chip" onclick="clearLoose()">Clear All</button>
            </div>
          </div>
        </section>
    </section>

    <section id="page-history" class="page">
      <button class="back-btn mb-4" onclick="goHome()">‚Üê Back to Main Menu</button>
      <h2 class="text-lg font-semibold mb-2">Journal History</h2>
      <div id="historyList" class="grid gap-3"></div>
    </section>

    <section class="p-4 text-xs text-slate-500">
      <p><strong>Privacy:</strong> All data is stored locally in your browser by default. When you turn on cloud sync later (Supabase + Google sign‚Äëin), your entries will save securely to your private database.</p>
    </section>
    
    <!-- ===== Beta Disclaimer Modal (always shows on Home) ===== -->
<div id="betaModal"
     class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Dialog -->
  <div class="relative max-w-2xl w-full">
    <div role="dialog" aria-modal="true" aria-labelledby="betaTitle"
         class="card rounded-2xl p-5 md:p-6 shadow-lg border border-white/15 bg-white/5">
      <h3 id="betaTitle" class="text-xl md:text-2xl font-semibold mb-3">
        üåô Moon Phase Life Guide (Early Beta Version) üåô
      </h3>

      <!-- Scrollable body -->
      <div id="betaBody" class="text-slate-300 text-sm leading-relaxed max-h-[65vh] overflow-auto pr-1 md:pr-2 space-y-4">
        <p>‚ú® Please be aware that this is a very early beta version of an app designed to help users align their life direction with the natural cycles of the moon. Through weekly meditative practices, the Moon Phase Life Guide supports reflection, balance, and gentle personal growth.</p>

        <div>
          <p class="font-medium text-slate-200">üåï Coming Soon:</p>
          <ul class="list-disc pl-5 space-y-2">
            <li>Exploration of global Indigenous moon traditions of approximately 120 global Indigenous moon-phase systems spanning 9 continental regions with 80+ specific cultural zones, and hundreds of individual phase names, symbolic cycles, and direct links to cultural and linguistic community data when available to the public.</li>
            <li>The ability to choose a moon tradition theme from different cultures that will adjust the art and prompts of your reflection and action cycles.</li>
            <li>Personal journaling archives with interactive word clouds for to help reflect on your goals and thoughts</li>
            <li>A to-do list goal tracker to organize weekly tasks within overarching life intentions</li>
            <li>Meditation ideas for reconnection with nature and Indigenous grounding traditions</li>
            <li>Organization and cleaning tips rooted in trauma-informed, compassionate care</li>
          </ul>
        </div>

        <div>
          <p class="font-medium text-slate-200">üåí Purpose of the App:</p>
          <p>This guide was created to help users cultivate mindfulness, balance, and healing by reconnecting with the natural cycles that have guided humanity for generations.</p>
        </div>

        <!-- Disclaimer footer (inside scroll) -->
        <div class="pt-2 border-t border-white/10 text-xs text-slate-400">
          Disclaimer: This is a beta version that currently includes only preliminary brainstorm research. More research is needed to verify the accuracy of cultural data. Please consult community-published sources for authoritative information.
        </div>
      </div>

      <!-- Actions -->
      <div class="mt-4 flex items-center justify-between gap-3">
        <label class="flex items-center gap-2 text-xs md:text-sm text-slate-300 select-none">
          <input id="betaAgree" type="checkbox"
                 class="accent-blue-400 rounded-sm">
          I agree
        </label>

        <div class="flex items-center gap-2">
          <button id="betaContinue"
                  class="bg-slate-900 text-white px-4 py-2 rounded-xl opacity-50 cursor-not-allowed"
                  disabled>
            Continue
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

  </main>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-geo-projection@4"></script>

    <script>
    
    // ===== Beta Modal logic (always open on Home) =====
    function showBetaNotice() {
      const modal = document.getElementById('betaModal');
      if (!modal) return;
    
      // Reset checkbox + button each time it opens
      const agree = document.getElementById('betaAgree');
      const btn   = document.getElementById('betaContinue');
      if (agree) agree.checked = false;
      if (btn) {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    
      // Show
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    
      // Wire up interactions (idempotent)
      if (agree && !agree._wired) {
        agree.addEventListener('change', () => {
          if (agree.checked) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
          } else {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
          }
        });
        agree._wired = true;
      }
    
      if (btn && !btn._wired) {
        btn.addEventListener('click', () => {
          closeBetaNotice();
        });
        btn._wired = true;
      }
    
      // ESC to close (only if agreed)
      document.addEventListener('keydown', escCloseOnce);
      function escCloseOnce(e){
        if (e.key === 'Escape' && agree && agree.checked) {
          closeBetaNotice();
          document.removeEventListener('keydown', escCloseOnce);
        }
      }
    }
    
    function closeBetaNotice() {
      const modal = document.getElementById('betaModal');
      if (!modal) return;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // ========================
    // STORAGE / UTIL
    // ========================
    const storeKey = 'mplc_v01';
    function loadState(){ try{ return JSON.parse(localStorage.getItem(storeKey)) || {}; } catch{ return {}; } }
    function saveState(s){ localStorage.setItem(storeKey, JSON.stringify(s)); }
    let state = loadState();
    
    function fmtDate(d){
      return d.toLocaleString([], {
        weekday: 'long',        // ‚Üê adds day of week
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(str){
      // Standard-safe HTML escaping
      return String(str).replace(/[&<>"']/g, ch => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
      }[ch]));
    }

    
    // --- Build a cosmic word backdrop from purposes, goals, and journal keywords
    async function rebuildCosmicBackground(){
      const host = document.getElementById('cosmic-bg');
      if (!host) return;
      host.innerHTML = '';
    
      const W = window.innerWidth, H = window.innerHeight;
    
      // a) purposes (up to 3)
      const purposes = (state.purposes || []).slice(0,3);
    
      // b) goals from Phase 2 checklist: prefer completed; else first few
      const goalsAll  = (state.plan?.checklist || []).map(x=>x.text);
      const goalsDone = (state.plan?.checklist || []).filter(x=>x.done).map(x=>x.text);
      const goals = (goalsDone.length ? goalsDone : goalsAll).slice(0,6);
    
      // c) 20‚Äì30 journal keywords from ALL entries this cycle
      const cycle   = await getOrCreateCurrentCycle();
      const entries = await idbIndexAll('entries','by_cycle', cycle.id);
      const topWords = topJournalWords(entries.map(e=>e.text).join(' '), 30);
    
      function put(txt, cls){
        const span = document.createElement('span');
        span.className = `t ${cls}`;
        span.textContent = txt;
    
        const pad = 40;
        const x = Math.random()*(W - pad*2) + pad;
        const y = Math.random()*(H - pad*2) + pad;
    
        span.style.left = x + 'px';
        span.style.top  = y + 'px';
        span.style.transform = `translate(-50%,-50%) rotate(${(Math.random()*8-4).toFixed(1)}deg)`;
        host.appendChild(span);
      }
    
      purposes.forEach(w=> put(w, 'A'));
      goals.forEach(w    => put(w, 'B'));
      topWords.forEach(w => put(w, 'C'));
    }
    
    // simple keyword extractor (syncs with your word-cloud approach)
    function topJournalWords(text, n=30){
      const stop = new Set([
        'the','and','a','an','to','of','in','for','on','with','it','is','that','this',
        'i','you','my','me','we','our','your','at','as','be','are','was','were','but',
        'so','if','or','by','from','about','into','than','then','there','here','not',
        'just','very','really','also','too','can','will','would','could','should'
      ]);
      const words = (text||'').toLowerCase()
        .replace(/[^a-z0-9\s']/g,' ')
        .split(/\s+/).map(w=>w.replace(/^'+|'+$/g,''))
        .filter(w=>w && w.length>2 && !stop.has(w));
    
      const freq = {};
      for (const w of words) freq[w]=(freq[w]||0)+1;
      return Object.entries(freq)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,n)
        .map(([w])=>w);
    }
    
    // ---- IndexedDB (local-first) ----
    const DB_NAME='moon_journal_v1', DB_VERSION=1;
    function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VERSION);
      r.onupgradeneeded=()=>{const db=r.result;
        if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
        if(!db.objectStoreNames.contains('cycles'))   db.createObjectStore('cycles');
        if(!db.objectStoreNames.contains('entries')){
          const s=db.createObjectStore('entries',{keyPath:'id',autoIncrement:true});
          s.createIndex('by_cycle','cycleId',{unique:false});
          s.createIndex('by_month','monthKey',{unique:false});
        }};
      r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
    async function idbGet(store,key){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly');const s=tx.objectStore(store);const g=s.get(key);g.onsuccess=()=>res(g.result);g.onerror=()=>rej(g.error);});}
    async function idbSet(store,key,val){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');const s=tx.objectStore(store);const p=s.put(val,key);p.onsuccess=()=>res(true);p.onerror=()=>rej(p.error);});}
    async function idbAdd(store,val){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');const s=tx.objectStore(store);const a=s.add(val);a.onsuccess=()=>res(a.result);a.onerror=()=>rej(a.error);});}
    async function idbIndexAll(store,idxName,query){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly');const idx=tx.objectStore(store).index(idxName);const g=idx.getAll(query);g.onsuccess=()=>res(g.result||[]);g.onerror=()=>rej(g.error);});}

    function monthKeyFromISO(iso){const d=new Date(iso);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;}
    
    // For now: treat calendar month as the ‚Äúcycle‚Äù
    async function getOrCreateCurrentCycle(){
      const now=new Date();
      const id=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-cycle`;
      const existing=await idbGet('cycles',id);
      if (existing) return existing;
      const cycle={id,start:new Date(now.getFullYear(),now.getMonth(),1).toISOString(),
                   end:new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59).toISOString(),
                   phaseName:'Waiting for Your Purpose'};
      await idbSet('cycles',id,cycle);
      return cycle;
    }
    
    function goHistory(){ location.hash = '#/history'; }
        
    // ========================
    // MOON MATH (fallback if SunCalc missing)
    // ========================
    function julianDay(date){ return date.getTime()/86400000 + 2440587.5; }
    function moonPhase(date){
      const jd = julianDay(date), newMoonRef = 2451550.1, synodic = 29.530588853;
      let age = (jd - newMoonRef) % synodic; if (age < 0) age += synodic;
      const illum = (1 - Math.cos(2*Math.PI*age/synodic))/2;
      const deg = age/synodic*360;
      let phaseName = (deg<1 || deg>=359) ? 'New Moon'
        : deg<45 ? 'Waxing Crescent'
        : deg<90 ? 'First Quarter'
        : deg<135? 'Waxing Gibbous'
        : deg<181? 'Full Moon'
        : deg<225? 'Waning Gibbous'
        : deg<270? 'Last Quarter'
        : 'Waning Crescent';
      const lifeStage = (deg>=45 && deg<180) ? 'Advance' : (deg>=175 && deg<=185) ? 'Celebrate' : (deg>185 && deg<360) ? 'Recap' : 'Wait';
      const nextFull = (age<=synodic/2) ? (synodic/2-age) : (synodic-age+synodic/2);
      const nextNew  = synodic - age;
      const nextEvent = lifeStage==='Celebrate' ? `New Moon in ${nextNew.toFixed(1)} days` : `Full Moon in ${nextFull.toFixed(1)} days`;
      return {illum, phaseName, lifeStage, nextEvent};
    }
    
    function drawMoon(container, illum, waxing, phase01){
      const w = container.clientWidth, h = container.clientHeight;
      const r = Math.min(w,h)/2, cx=w/2, cy=h/2;
    
      container.innerHTML = '';
      const NS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(NS,'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      container.appendChild(svg);
    
      // Dark background disk
      const dark = document.createElementNS(NS,'circle');
      dark.setAttribute('cx',cx); dark.setAttribute('cy',cy); dark.setAttribute('r',r);
      dark.setAttribute('fill','#0b1324');
      svg.appendChild(dark);
    
      // Full lit moon
      const lit = document.createElementNS(NS,'circle');
      lit.setAttribute('cx',cx); lit.setAttribute('cy',cy); lit.setAttribute('r',r);
      lit.setAttribute('fill','white');
      svg.appendChild(lit);
    
      // Shadow crescent
      const shadow = document.createElementNS(NS,'rect');
      shadow.setAttribute('x', waxing ? cx : cx - 2*r);
      shadow.setAttribute('y', cy - r);
      shadow.setAttribute('width', 2*r * (1-illum));
      shadow.setAttribute('height', 2*r);
      shadow.setAttribute('fill','#0b1324');
      svg.appendChild(shadow);
    
      // Limb glow
      const glow = document.createElementNS(NS,'circle');
      glow.setAttribute('cx',cx); glow.setAttribute('cy',cy); glow.setAttribute('r',r);
      glow.setAttribute('fill','none');
      glow.setAttribute('stroke','rgba(255,255,255,.2)');
      glow.setAttribute('stroke-width','1.5');
      svg.appendChild(glow);
    }


    let mapInit = false;
    function ensureMap() {
      if (mapInit) return;
      const el = document.querySelector('#page-home #worldMap');
      if (el) { renderWorldMap(); mapInit = true; }
    }

    // ========================
    // JOURNAL + WORD CLOUD
    // ========================
    function saveJournal(){
      state.journal = document.getElementById('journalInput').value || '';
      state.journalSavedAt = Date.now(); saveState(state);
      const el = document.getElementById('journalSaved');
      if (el){ el.textContent = 'Saved.'; setTimeout(()=>el.textContent='',1500); }
    }
    
    function buildWordCloud(targetTotal = 230){
      const text = (document.getElementById('journalInput').value || '').toLowerCase();
    
      const stop = new Set([
        'the','and','a','an','to','of','in','for','on','with','it','is','that','this',
        'i','you','my','me','we','our','your','at','as','be','are','was','were','but',
        'so','if','or','by','from','about','into','than','then','there','here','not',
        'just','very','really','also','too','can','will','would','could','should'
      ]);
    
      const words = text.replace(/[^a-z0-9\s']/g,' ')
        .split(/\s+/)
        .map(w=>w.replace(/^'+|'+$/g,''))
        .filter(w => w && w.length>2 && !stop.has(w));
    
      const cloud = document.getElementById('cloud');
      cloud.innerHTML = '';
    
      if (!words.length){
        cloud.innerHTML = '<div class="text-slate-400 text-sm absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">Type a little more, then tap ‚ÄúBuild Word Cloud‚Äù.</div>';
        return;
      }
    
      // ---- freq + tie-shuffle ----
      const freq = {};
      for (const w of words) freq[w] = (freq[w]||0)+1;
    
      let entries = Object.entries(freq);
      const buckets = new Map();
      for (const e of entries){
        const c = e[1];
        (buckets.get(c) || buckets.set(c,[]).get(c)).push(e);
      }
      for (const g of buckets.values()){
        for (let i=g.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [g[i],g[j]] = [g[j],g[i]];
        }
      }
      entries = [...buckets.keys()].sort((a,b)=>b-a).flatMap(k => buckets.get(k));
      entries = entries.slice(0, targetTotal);
    
      // ---- tiers (10 √ó 23) & sizes (smaller tail) ----
      const tierSize = 23, maxTiers = 10;
      const tiers = [];
      for (let t=0; t<maxTiers; t++){
        const a = t*tierSize, b = a + tierSize;
        const slice = entries.slice(a, b);
        if (!slice.length) break;
        tiers.push(slice);
      }
      const sizes = [60,46,36,30,26,22,18,14,12,9]; // px
      const minTiny = 8;                             // absolute minimum
    
      // ---- stage + helpers ----
      const W = cloud.clientWidth || 680, H = cloud.clientHeight || 420;
      const cx = W/2, cy = H/2;
      const placed = []; // list of bounding boxes
    
      const palette = [
        [265,72,88],[210,70,88],[305,70,86],[185,55,86],
        [230,75,88],[280,68,86],[195,58,88]
      ];
      const golden = Math.PI * (3 - Math.sqrt(5));
      const pad = 6;                 // collision padding around each word
      const inflate = 1.08;          // widen bbox a tad to account for tiny rotation
    
      function colorFor(i){
        const [h,s,l] = palette[i % palette.length];
        return `hsl(${h} ${s}% ${l}%)`;
      }
      function overlaps(box){
        for (const q of placed){
          if (box.x1 < q.x2 && box.x2 > q.x1 && box.y1 < q.y2 && box.y2 > q.y1) return true;
        }
        return false;
      }
    
      let gid = 0; // global index for color variety
    
      tiers.forEach((tier, ti)=>{
        const baseSize = sizes[ti] || sizes[sizes.length-1];
        const tierBias = (ti/(sizes.length-1));
        const baseR = Math.min(W,H) * (0.06 + tierBias * 0.42);
    
        tier.forEach(([w], k)=>{
          let fs = baseSize;
          let placedOk = false, triesTotal = 0;
    
          // Shrink-and-retry loop if it can't fit
          while (!placedOk && fs >= minTiny){
            const span = document.createElement('span');
            span.className = 'wc';
            span.textContent = w;
            span.style.fontSize = fs + 'px';
            span.style.color = colorFor(gid++);
            span.style.textShadow =
              `0 0 ${Math.round(fs/3)}px rgba(180,210,255,.28),
               0 0 ${Math.round(fs/1.6)}px rgba(150,180,255,.18)`;
            cloud.appendChild(span);
    
            // Measure
            const wpx = span.offsetWidth * inflate;
            const hpx = span.offsetHeight * inflate;
    
            // Spiral search
            let a = (k + ti*17) * golden;
            let r = baseR;
            let x=0, y=0, tries=0;
            const maxTries = 380; // more patience
    
            while(tries < maxTries){
              x = cx + Math.cos(a)*r;
              y = cy + Math.sin(a)*r;
              const box = {
                x1: x - wpx/2 - pad,
                y1: y - hpx/2 - pad,
                x2: x + wpx/2 + pad,
                y2: y + hpx/2 + pad
              };
              const inBounds = (box.x1>4 && box.y1>4 && box.x2<W-4 && box.y2<H-4);
    
              if (inBounds && !overlaps(box)){
                // place
                placed.push(box);
                const rot = (Math.random()*6 - 3);
                span.style.left = x + 'px';
                span.style.top  = y + 'px';
                span.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
                placedOk = true;
                break;
              }
              // advance
              a += golden;
              r += 8 + ti*1.6; // slightly bigger outward step than before
              tries++; triesTotal++;
            }
    
            if (!placedOk){
              // remove & shrink for another attempt
              cloud.removeChild(span);
              fs -= (fs > 20 ? 4 : 2); // shrink faster when big, gently when small
            }
          }
          // If it never fit, we just skip it‚Äîno overlap introduced.
        });
      });
    }

    // AUTOSAVE draft so nothing gets lost
    let autosaveTimer=null;
    async function loadDraft(){
      const s=(await idbGet('settings','app'))||{};
      if (s.autosaveDraft) document.getElementById('journalInput').value = s.autosaveDraft;
      const saveDraft=async()=>{
        const val=document.getElementById('journalInput').value;
        const cur=(await idbGet('settings','app'))||{};
        cur.autosaveDraft=val; await idbSet('settings','app',cur);
      };
      ['input','blur'].forEach(ev=>{
        document.getElementById('journalInput').addEventListener(ev, ()=>{
          clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveDraft, 800);
        });
      });
      document.addEventListener('visibilitychange', ()=>{ if (document.hidden) saveDraft(); });
    }
    
    async function submitEntry(){
      const ta=document.getElementById('journalInput');
      const text=(ta.value||'').trim();
      if(!text) return;
      const cycle=await getOrCreateCurrentCycle();
      const createdAtISO=new Date().toISOString();
      await idbAdd('entries',{
        cycleId:cycle.id, createdAtISO, text,
        wordCount:text.split(/\s+/).length, charCount:text.length,
        monthKey:monthKeyFromISO(createdAtISO)
      });
      // clear draft + textarea
      const s=(await idbGet('settings','app'))||{}; s.autosaveDraft=null; await idbSet('settings','app',s);
      ta.value=''; saveJournal();
      await refreshCurrentCycleUI();
      await rebuildCosmicBackground();
    }
    
    // Build feed + make cloud from ALL entries in the current cycle
    async function refreshCurrentCycleUI(){
      const cycle=await getOrCreateCurrentCycle();
      const entries=(await idbIndexAll('entries','by_cycle', cycle.id))
        .sort((a,b)=> new Date(a.createdAtISO)-new Date(b.createdAtISO));
    
      // list UI
      const list=document.getElementById('entryList'); if (list){ list.innerHTML='';
        entries.forEach(e=>{
          const card=document.createElement('div');
          card.className='rounded-xl border border-white/15 bg-white/5 p-3';
          const when=new Date(e.createdAtISO).toLocaleString();
          const p=document.createElement('p'); const full=e.text;
          const preview = full.length>200 ? full.slice(0,200)+'‚Ä¶' : full;
          p.textContent=preview;
          const btn=document.createElement('button');
          btn.className='underline text-xs opacity-80 mt-1';
          btn.textContent='Expand';
          btn.onclick=()=>{ const open = (p.textContent===full); p.textContent=open?preview:full; btn.textContent=open?'Expand':'Collapse'; };
          card.innerHTML=`<div class="text-[11px] opacity-60 mb-1">${when}</div>`;
          card.appendChild(p); card.appendChild(btn); list.appendChild(card);
        });
      }
    
      // cloud from ALL entries (reuse your existing builder)
      const textAll = entries.map(e=>e.text).join(' ');
      buildWordCloudFromText(textAll, 230);
    }

    async function buildHistory(){
      const db=await openDB();
      const months = await new Promise((res,rej)=>{
        const tx=db.transaction('entries','readonly');
        const s=tx.objectStore('entries'); const g=s.getAll();
        g.onsuccess=()=>{const m=new Map();
          (g.result||[]).forEach(e=>{
            const key=e.monthKey||monthKeyFromISO(e.createdAtISO);
            if(!m.has(key)) m.set(key,[]);
            m.get(key).push(e);
          });
          res([...m.entries()].sort((a,b)=> a[0]<b[0]?1:-1)); // newest first
        }; g.onerror=()=>rej(g.error);
      });
    
      const wrap=document.getElementById('historyList'); if(!wrap) return;
      wrap.innerHTML='';
      months.forEach(([key,entries])=>{
        const sec=document.createElement('div');
        sec.className='rounded-xl border border-white/15 bg-white/5';
        const title = new Date(key+'-01').toLocaleDateString(undefined,{year:'numeric',month:'long'});
        sec.innerHTML = `
          <div class="flex items-center justify-between p-3">
            <div class="font-medium">${title}</div>
            <div class="flex gap-2">
              <button class="chip px-2 py-1 rounded-lg" onclick="exportMonth('${key}')">Export</button>
              <button class="chip px-2 py-1 rounded-lg" onclick="this.nextElementSibling.classList.toggle('hidden')">Toggle</button>
            </div>
          </div>
          <div class="p-3 hidden"></div>`;
        const body=sec.lastElementChild;
        entries.sort((a,b)=>new Date(a.createdAtISO)-new Date(b.createdAtISO))
          .forEach(e=>{
            const p=document.createElement('div');
            p.className='text-sm opacity-90 mb-2';
            p.innerHTML=`<div class="opacity-60 text-[11px]">${new Date(e.createdAtISO).toLocaleString()}</div>
                         <div>${(e.text.length>300? e.text.slice(0,300)+'‚Ä¶' : e.text)
                           .replace(/[&<>]/g,s=>({ '&':'&','<':'<','>':'>' }[s]))}</div>`;
            body.appendChild(p);
          });
        wrap.appendChild(sec);
      });
    }
    
    async function exportMonth(monthKey){
      const db=await openDB();
      const all=await new Promise((res,rej)=>{const tx=db.transaction('entries','readonly');
        const idx=tx.objectStore('entries').index('by_month'); const g=idx.getAll(monthKey);
        g.onsuccess=()=>res(g.result||[]); g.onerror=()=>rej(g.error);});
      const blob=new Blob([JSON.stringify({monthKey,entries:all},null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`moon-journal-${monthKey}.json`; a.click(); URL.revokeObjectURL(a.href);
    }
    
    async function exportCurrentCycle(){
      const cycle=await getOrCreateCurrentCycle();
      const entries=await idbIndexAll('entries','by_cycle',cycle.id);
      const blob=new Blob([JSON.stringify({cycle,entries},null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`moon-cycle-${cycle.id}.json`; a.click(); URL.revokeObjectURL(a.href);
    }
    
    // Temporary input swap to reuse your buildWordCloud()
    function buildWordCloudFromText(allText, total){
      const ta = document.getElementById('journalInput');
      if (!ta) return;
      const orig = ta.value;
      ta.value = allText;
      buildWordCloud(total);
      ta.value = orig;
    }
    
    
    // ========================
    // PHASE 2 PLAN / CHECKLIST
    // ========================
    function generateChecklist(){
      const goal = document.getElementById('goal').value.trim();
      const scaff = (document.getElementById('scaffolds').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      const steps = (document.getElementById('steps').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
      state.plan = { goal, scaff, steps, checklist: steps.map(s=>({text:s, done:false})) };
      saveState(state); renderChecklist(); renderCarryOver();
      rebuildCosmicBackground();
    }
    function clearPlan(){ delete state.plan; saveState(state); renderChecklist(); renderCarryOver(); }
    function toggleCheck(i){ state.plan.checklist[i].done = !state.plan.checklist[i].done; saveState(state); renderChecklist(); renderCarryOver(); rebuildCosmicBackground();}
    function renderChecklist(){
      const ul = document.getElementById('checklist'); ul.innerHTML='';
      if(!state.plan){ ul.innerHTML = '<li class="text-slate-500 text-sm">No checklist yet.</li>'; return; }
      if(state.plan.goal){ ul.insertAdjacentHTML('beforeend', `<li class="text-slate-600">Goal: <strong>${escapeHtml(state.plan.goal)}</strong></li>`); }
      state.plan.checklist.forEach((item,i)=>{
        const li = document.createElement('li'); li.className='flex items-center gap-3';
        li.innerHTML = `<input type="checkbox" ${item.done?'checked':''} onchange="toggleCheck(${i})" /> <span ${item.done?'class="line-through text-slate-400"':''}>${escapeHtml(item.text)}</span>`;
        ul.appendChild(li);
      });
    }
    

    // === Phase 4 "Loom of Stars" background =========================
    function renderLoomBackground(){
      const host = document.getElementById('loomBG');
      if (!host) return;
    
      // clear + size
      host.innerHTML = '';
      const w = host.clientWidth || 1024;
      const h = host.clientHeight || 640;
    
      const NS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(NS, 'svg');
      svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
      svg.setAttribute('preserveAspectRatio', 'none');
      host.appendChild(svg);
    
      // ---- gradient night sky ----
      const defs = document.createElementNS(NS, 'defs');
      svg.appendChild(defs);
    
      const grad = document.createElementNS(NS, 'radialGradient');
      grad.setAttribute('id', 'gNight');
      grad.setAttribute('cx', '70%'); grad.setAttribute('cy', '0%');
      grad.setAttribute('r', '100%');
        // inside renderLoomBackground()
        grad.innerHTML = `
          <stop offset="0%"  stop-color="#9678dc" stop-opacity=".20"/>
          <stop offset="45%" stop-color="#080c18" stop-opacity=".20"/>
          <stop offset="100%" stop-color="#080c18" stop-opacity="1"/>
        `;
      defs.appendChild(grad);
    
      const bg = document.createElementNS(NS, 'rect');
      bg.setAttribute('width', w); bg.setAttribute('height', h);
      bg.setAttribute('fill', 'url(#gNight)');
      svg.appendChild(bg);
    
      // ---- stars (two layers, twinkling via opacity animation) ----
      const style = document.createElementNS(NS, 'style');
      style.textContent = `
        @keyframes twA { 0%{opacity:.45} 50%{opacity:1} 100%{opacity:.45} }
        @keyframes twB { 0%{opacity:.35} 50%{opacity:.9} 100%{opacity:.35} }
        .twA { animation: twA 8s linear infinite; }
        .twB { animation: twB 11s linear infinite reverse; }
        .thread { vector-effect: non-scaling-stroke; }
      `;
      defs.appendChild(style);
    
      function rand(min, max){ return min + Math.random()*(max-min); }
    
      // scatter stars
      function addStars(count, cls, sizeRange, colorRange){
        const g = document.createElementNS(NS, 'g');
        g.setAttribute('class', cls);
        for (let i=0;i<count;i++){
          const c = document.createElementNS(NS, 'circle');
          c.setAttribute('cx', rand(0,w));
          c.setAttribute('cy', rand(0,h));
          c.setAttribute('r', rand(sizeRange[0], sizeRange[1]));
          const hue = rand(colorRange[0], colorRange[1]);
          const alpha = rand(0.5, 0.9);
          c.setAttribute('fill', `hsla(${hue}, 80%, 88%, ${alpha})`);
          g.appendChild(c);
        }
        svg.appendChild(g);
      }
    
      addStars(Math.round(w*h/9000), 'twA', [0.6,1.4], [190,240]); // small
      addStars(Math.round(w*h/22000), 'twB', [1.2,2.2], [210,270]); // medium
        
      // ---- luminous threads (the ‚Äúloom‚Äù) ---------------------------
      const threadG = document.createElementNS(NS, 'g');
      threadG.setAttribute('opacity', '.85');
      svg.appendChild(threadG);
    
      const lanes = 6;                          // horizontal warp threads
      for (let i=0;i<lanes;i++){
        const y = h*(0.18 + i*(0.64/(lanes-1)));
        const p = [];
        const segments = 10;
        for (let s=0; s<=segments; s++){
          const x = (w/segments)*s;
          const jitter = Math.sin((s+i*1.7))*12 + (Math.random()-0.5)*8;
          p.push([x, y + jitter]);
        }
        const d = 'M ' + p.map(([x,y])=>`${x},${y}`).join(' L ');
        const path = document.createElementNS(NS, 'path');
        path.setAttribute('d', d);
        path.setAttribute('fill','none');
        path.setAttribute('stroke','rgba(180,210,255,.25)');
        path.setAttribute('stroke-width','1');
        path.setAttribute('class','thread');
        path.setAttribute('stroke-dasharray','6 8');
        path.setAttribute('stroke-linecap','round');
        threadG.appendChild(path);
    
        // subtle ‚Äúweft‚Äù stitch lines crossing
        for (let k=0;k<5;k++){
          const x = rand(0.1*w, 0.9*w);
          const y2 = y + rand(-30,30);
          const weft = document.createElementNS(NS, 'line');
          weft.setAttribute('x1', x-60); weft.setAttribute('y1', y2-3);
          weft.setAttribute('x2', x+60); weft.setAttribute('y2', y2+3);
          weft.setAttribute('stroke','rgba(155,185,255,.16)');
          weft.setAttribute('stroke-width','0.9');
          weft.setAttribute('class','thread');
          threadG.appendChild(weft);
    
          // tiny join star
          const join = document.createElementNS(NS, 'circle');
          join.setAttribute('cx', x); join.setAttribute('cy', y2);
          join.setAttribute('r', 1.8);
          join.setAttribute('fill', 'rgba(255,255,255,.85)');
          join.setAttribute('class','twA');
          threadG.appendChild(join);
        }
      }
    
      // ---- optional: whispered words stitched into the sky --------
      // Pull top 2‚Äì3 purposes & a handful of cloud words if available.
      try{
        const purposes = (window.state?.purposes || []).slice(0,3);
        const extras = extractTopWordsFromCloud?.(20) || [];
        const words = [...purposes, ...extras].slice(0, 28);
    
        const wordG = document.createElementNS(NS, 'g');
        svg.appendChild(wordG);
    
        words.forEach((wtxt, idx)=>{
          const tx = document.createElementNS(NS, 'text');
          tx.textContent = String(wtxt);
          tx.setAttribute('x', rand(0.1*w, 0.9*w));
          tx.setAttribute('y', rand(0.15*h, 0.85*h));
          tx.setAttribute('fill', 'rgba(210,225,255,.28)');
          tx.setAttribute('font-size', String(rand(10, 22)));
          tx.setAttribute('font-family', 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif');
          tx.setAttribute('letter-spacing', '.02em');
          tx.setAttribute('style', `text-shadow:0 0 18px rgba(140,180,255,.2)`);
          wordG.appendChild(tx);
        });
      }catch(_) { /* fail quietly if cloud isn‚Äôt built yet */ }
    }
    
    // Helper to read some words from your cloud if present
    function extractTopWordsFromCloud(n=20){
      const nodes = Array.from(document.querySelectorAll('#cloud .wc'));
      if (!nodes.length) return [];
      // take visually larger ones first
      nodes.sort((a,b)=>parseFloat(b.style.fontSize||'0') - parseFloat(a.style.fontSize||'0'));
      return nodes.slice(0,n).map(el=>el.textContent).filter(Boolean);
    }
    
    // ========================
    // PHASE 4 CARRY-OVER + LOOSE ENDS
    // ========================
    function renderCarryOver(){
      const ul = document.getElementById('carryOver'); ul.innerHTML='';
      if(!state.plan){ ul.innerHTML = '<li class="text-slate-500 text-sm">No Phase 2 plan found.</li>'; return; }
      const pending = state.plan.checklist.map((c,i)=>({i,...c})).filter(c=>!c.done);
      if(!pending.length){ ul.innerHTML = '<li class="text-slate-500 text-sm">Nothing to carry over ‚Äî you finished everything. ‚ú®</li>'; return; }
      pending.forEach(p=>{
        const li = document.createElement('li');
        li.innerHTML = `<label class="flex items-center gap-2"><input type="checkbox" data-carry-index="${p.i}"/> <span>${escapeHtml(p.text)}</span></label>`;
        ul.appendChild(li);
      });
    }
    function carrySelected(){
      const boxes = [...document.querySelectorAll('[data-carry-index]')].filter(b=>b.checked);
      if(!boxes.length) return;
      state.nextCycle = state.nextCycle || { checklist: [], loose: [] };
      boxes.forEach(b=>{
        const i = +b.getAttribute('data-carry-index');
        const item = state.plan.checklist[i];
        state.nextCycle.checklist.push({text:item.text, done:false, from:'phase2'});
      });
      saveState(state);
      alert('Added to next cycle.');
    }
    // Loose ends
    function addLoose(){
      const v = document.getElementById('looseInput').value.trim(); if(!v) return;
      state.loose = state.loose || []; state.loose.push({text:v, done:false});
      document.getElementById('looseInput').value=''; saveState(state); renderLoose();
    }
    function toggleLoose(i){ state.loose[i].done = !state.loose[i].done; saveState(state); renderLoose(); }
    function archiveLoose(){ if(!state.loose) return; state.loose = state.loose.filter(x=>!x.done); saveState(state); renderLoose(); }
    function clearLoose(){ delete state.loose; saveState(state); renderLoose(); }
    function renderLoose(){
      const ul = document.getElementById('looseList'); ul.innerHTML='';
      const items = state.loose||[];
      if(!items.length){ ul.innerHTML = '<li class="text-slate-500 text-sm">No loose ends captured yet.</li>'; return; }
      items.forEach((it,i)=>{
        const li = document.createElement('li'); li.className='flex items-center gap-3';
        li.innerHTML = `<input type="checkbox" ${it.done?'checked':''} onchange="toggleLoose(${i})" /> <span ${it.done?'class="line-through text-slate-400"':''}>${escapeHtml(it.text)}</span>`;
        ul.appendChild(li);
      });
    }
    
    // ========================
    // CELEBRATE & PROFILE
    // ========================
    function ackCelebrate(){ state.celebrateAck = Date.now(); saveState(state); const el=document.getElementById('celebrateAck'); if(el) el.textContent='Have a beautiful week.'; }
    function setSeasonalProfile(mode){ state.profile = mode; saveState(state); alert('Seasonal profile set to: '+mode.toUpperCase()); }
    function toggleTheme(){ document.documentElement.classList.toggle('dark'); }
    
    // ========================
    // PURPOSES (1‚Äì5) + TASKS (with nested subtasks up to 3 levels)
    // ========================
    
    // ---------- Helpers ----------
    function monthKeyFromDate(d=new Date()){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    
    // ---------- Purposes (per cycle, capped at 5) ----------
    function purposeState(){ state.purposes = state.purposes || []; return state.purposes; }
    
    function addPurpose(){
      const inp = document.getElementById('purposeInput');
      const v = (inp.value||'').trim();
      if (!v) return;
      const arr = purposeState();
      if (arr.length >= 5){ alert('You can add up to five purposes.'); return; }
      arr.push(v);
      inp.value = '';
      saveState(state);
      renderPurposeList();
      updateMyPurposeBanner();
      rebuildCosmicBackground();
    }
    
    function removePurpose(i){
      const arr = purposeState();
      arr.splice(i,1);
      saveState(state);
      renderPurposeList();
      updateMyPurposeBanner();
    }
    
    function renderPurposeList(){
      const ul = document.getElementById('purposeList');
      if (!ul) return;
      ul.innerHTML = '';
      const arr = purposeState();
      if (!arr.length){
        ul.innerHTML = `
          <li class="text-slate-500 text-sm">1. Fill in your most pressing purpose</li>
          <li class="text-slate-500 text-sm">2. Fill in your second most crucial purpose</li>
          <li class="text-slate-500 text-sm">3. Fill in another purpose that is important to you</li>
        `;
        return;
      }
      arr.forEach((txt, i)=>{
        const li = document.createElement('li');
        li.className = 'flex items-start gap-2';
        li.innerHTML = `
          <div class="pt-2 text-slate-400">${i+1}.</div>
          <div class="flex-1">
            <div class="rounded-xl border border-white/15 bg-white/5 p-2">${escapeHtml(txt)}</div>
          </div>
          <button class="chip px-2 py-1 rounded-lg" title="Remove" onclick="removePurpose(${i})">‚úï</button>
        `;
        ul.appendChild(li);
      });
    }
    
    function updateMyPurposeBanner(){
      const el = document.getElementById('myPurpose');
      if (!el) return;
      const arr = purposeState();
      el.textContent = arr.length ? arr.join(' ‚Ä¢ ') : '‚Äî';
      rebuildCosmicBackground();
    }
    
    // ---------- Tasks (persist across cycles until deleted) ----------
    function taskState(){ state.tasks = state.tasks || []; return state.tasks; }
    function taskArchiveState(){ state.taskArchive = state.taskArchive || {}; return state.taskArchive; }
    
    // ----- Task helpers (robust + consistent 0-based depth) -----
    function findTask(id, list = taskState()) {
      for (const t of list) {
        if (t.id === id) return t;
        const hit = findTask(id, t.children || []);
        if (hit) return hit;
      }
      return null;
    }
    
    // depth: 0 = root task, 1 = child, 2 = grandchild
    function taskDepth(id, list = taskState(), depth = 0) {
      for (const t of list) {
        if (t.id === id) return depth;
        const d = taskDepth(id, t.children || [], depth + 1);
        if (d !== -1) return d;
      }
      return -1;
    }
    
    function taskAdd(text, parentId = null) {
      text = (text || '').trim();
      if (!text) return;
    
      const t = { id: uid(), text, done: false, children: [] };
    
      if (parentId) {
        const parent = findTask(parentId);
        if (!parent) return;
    
        // 0-based depth cap ‚áí allow up to depth 2 (grandchild)
        const d = taskDepth(parentId);        // parent depth
        if (d >= 2) {                         // parent already a grandchild
          alert('Sub-sub-tasks are the deepest level.');
          return;
        }
        parent.children.push(t);
      } else {
        taskState().push(t);
      }
    
      saveState(state);
      renderTaskList();
    }

    
    function deleteTask(id, list=taskState()){
      const i = list.findIndex(t=>t.id===id);
      if (i !== -1){ list.splice(i,1); return true; }
      for (const t of list){
        if (deleteTask(id, t.children)) return true;
      }
      return false;
    }
    
    function taskToggle(id){
      const t = findTask(id, taskState());
      if (!t) return;
      t.done = !t.done;
      saveState(state);
      renderTaskList();
    }
    
    function taskAddChildPrompt(id){
      const v = prompt('Add a sub-task:');
      if (v) taskAdd(v, id);
    }
    
    function taskDelete(id){
      deleteTask(id, taskState());
      saveState(state);
      renderTaskList();
    }
    
    function taskArchiveCompleted(){
      const monthKey = monthKeyFromDate(new Date());
      const archive = taskArchiveState();
      archive[monthKey] = archive[monthKey] || [];
    
      // collect & prune (recursive)
      function collectDone(list){
        const keep = [];
        for (const t of list){
          if (t.done){
            archive[monthKey].push({ ...t, archivedAt: new Date().toISOString() });
          } else {
            t.children = collectDone(t.children||[]);
            keep.push(t);
          }
        }
        return keep;
      }
      state.tasks = collectDone(taskState());
      saveState(state);
      renderTaskList();
      alert('Completed tasks archived.');
    }
    
    function taskClearAll(){
      if (!confirm('Clear ALL current tasks? This does not delete the archive.')) return;
      state.tasks = [];
      saveState(state);
      renderTaskList();
    }
 
 
    // inline add from a field under a task
    function taskAddFromField(parentId){
      const inp = document.getElementById(`subInp-${parentId}`);
      if (!inp) return;
      const v = (inp.value || '').trim();
      if (!v) return;
      taskAdd(v, parentId);  // uses your existing taskAdd(text, parentId)
      inp.value = '';
    }
    
    function showSubField(id){
      const wrap = document.getElementById(`subWrap-${id}`);
      const trig = document.getElementById(`subTrig-${id}`);
      if (!wrap) return;
      wrap.classList.remove('hidden');
      if (trig) trig.classList.add('hidden');
      const inp = document.getElementById(`subInp-${id}`);
      if (inp) inp.focus();
    }
    
    function cancelSubField(id){
      const wrap = document.getElementById(`subWrap-${id}`);
      const trig = document.getElementById(`subTrig-${id}`);
      if (wrap) wrap.classList.add('hidden');
      if (trig) trig.classList.remove('hidden');
    }

   
    function renderTaskList(){
      const ul = document.getElementById('taskList');
      if (!ul) return;
      ul.innerHTML = '';
    
      // recursive renderer
      function renderItems(list, container, depth = 0){
        list.forEach(t=>{
          const li = document.createElement('li');
          li.className = 'rounded-xl border border-white/15 bg-white/5 p-2';
          // indent by depth (0,1,2) ‚Üí ml-0, ml-5, ml-10
          li.style.marginLeft = `${depth * 1.25}rem`;
    
        li.innerHTML = `
          <div class="flex items-center gap-2">
            <input type="checkbox" ${t.done ? 'checked' : ''} onchange="taskToggle('${t.id}')" />
            <div class="flex-1 ${t.done ? 'line-through text-slate-400' : ''}">${escapeHtml(t.text)}</div>
        
            ${depth < 2 ? `
              <button id="subTrig-${t.id}" class="chip px-2 py-1 rounded-lg" onclick="showSubField('${t.id}')">
                Add sub-task
              </button>
            ` : ''}
        
            <button class="chip px-2 py-1 rounded-lg" onclick="taskDelete('${t.id}')">Delete</button>
          </div>
        
          ${depth < 2 ? `
            <div id="subWrap-${t.id}" class="hidden mt-2">
              <div class="flex items-center gap-2">
                <input id="subInp-${t.id}" class="flex-1 p-2 rounded-lg border border-slate-200"
                       placeholder="Add a sub-task‚Ä¶"
                       onkeydown="if(event.key==='Escape'){ cancelSubField('${t.id}') } if(event.key==='Enter'){ taskAddFromField('${t.id}'); cancelSubField('${t.id}') }"/>
                <button class="bg-slate-900 text-white px-4 py-2 rounded-xl"
                        onclick="taskAddFromField('${t.id}'); cancelSubField('${t.id}')">
                  Add
                </button>
                <button class="chip px-2 py-1 rounded-lg" onclick="cancelSubField('${t.id}')">Cancel</button>
              </div>
            </div>
          ` : ''}
        `;

    
          container.appendChild(li);
    
          // children list (one level deeper)
          if (t.children && t.children.length){
            const childUL = document.createElement('ul');
            childUL.className = 'mt-2 space-y-2';
            li.appendChild(childUL);
            renderItems(t.children, childUL, depth + 1);
          }
        });
      }
    
      renderItems(taskState(), ul, 0);
    }

    
    // Hook for the Phase-2 inputs:
    function taskAddFromInput(){
      const inp = document.getElementById('taskInput');
      const v = (inp.value||'').trim();
      if (!v) return;
      taskAdd(v);
      inp.value='';
    }
    
    // Keep the Home ‚ÄúMy Purpose‚Äù banner fresh once per minute as well
    setInterval(updateMyPurposeBanner, 60*1000);

    
    // Helper: days until the next quarter boundary (New -> 0, First -> .25, Full -> .5, Last -> .75)
    function daysUntilNextQuarter(phase0to1){
      const syn = 29.530588853;
      const quarters = [0, 0.25, 0.5, 0.75, 1];
      const now = phase0to1 % 1;
      const next = quarters.find(q => q > now) ?? 1;
      return (next - now) * syn;
    }
    
    // --- Simple router ---
    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>{
        p.classList.toggle('active', p.id === id);
      });
    
      // Page-enter hooks
      if (id === 'page-phase-2') {
        renderPurposeList();
        renderTaskList();       // <- ensures existing tasks appear immediately
      }
      if (id === 'page-phase-4') {
        renderLoomBackground();
        renderCarryOver();
        renderLoose();
      }
      if (id === 'page-history') {
        buildHistory();
      }
    }

    
    function defaultPhaseNumber(){
      try{
        const now = new Date();
        if (window.SunCalc){
          const m = SunCalc.getMoonIllumination(now);
          const deg = m.phase * 360;
          const lifeStage = (deg>=45&&deg<180)?'Advance'
            : (deg>=175&&deg<=185)?'Celebrate'
            : (deg>185&&deg<360)?'Recap' : 'Wait';
          return autoPhaseFromLifeStage(lifeStage);
        } else {
          return autoPhaseFromLifeStage(moonPhase(now).lifeStage);
        }
      } catch(e){ return 1; }
    }
    
    function route(){
      const m = (location.hash||'').match(/^#\/phase\/([1-4])$/);
      if (m){
        const n = parseInt(m[1],10);
        state.activePhase = n; saveState(state);
        rotateRingForPhase(n);
        markCurrent(n);
        showPage('page-phase-' + n);
      } else if ((location.hash||'') === '#/history'){
        showPage('page-history');
        buildHistory();
      } else {
        const n = state.activePhase || defaultPhaseNumber();
        rotateRingForPhase(n);
        markCurrent(n);
        showPage('page-home');
        ensureMap();
        showBetaNotice();
      }
    }

    function goHome(){ location.hash = '#/home'; }
    function goPhase(n){ location.hash = '#/phase/' + n; }

    
    // Returns a Date for the next quarter boundary based on current phase (0..1)
    function nextQuarterDate(phase0to1, now=new Date()){
      const syn = 29.530588853; // days
      const quarters = [0, 0.25, 0.5, 0.75, 1];
      const cur = phase0to1 % 1;
      const next = quarters.find(q => q > cur) ?? 1;
      const deltaDays = (next - cur) * syn;
      return new Date(now.getTime() + deltaDays * 86400000);
    }

    // ===== Moon art frames (1..28) =====
    // Place your images at assets/moon1.png ... moon28.png
    const MOON_ART_PATH = 'assets/';
    const MOON_ART_COUNT = 28;
    
    // Map phase (0..1, where 0 = new, 0.5 = full) to your index 1..28
    function artIndexFromPhase(phase01){
      // normalize to [0,1)
      const p = ((phase01 % 1) + 1) % 1;
      const half = 0.5;
    
      if (p <= half){
        // New -> Full maps to 1..13
        const t = p / half;                         // 0..1
        return Math.max(1, Math.min(13, Math.round(1 + t * (13 - 1))));
      } else {
        // Full -> New maps to 13..28
        const t = (p - half) / (1 - half);          // 0..1
        return Math.max(13, Math.min(28, Math.round(13 + t * (28 - 13))));
      }
    }
    
    // (Optional) Preload all frames so swaps are instant
    (function preloadMoons(){
      const list = [];
      for (let i=1; i<=MOON_ART_COUNT; i++){
        const im = new Image();
        im.src = `${MOON_ART_PATH}moon${i}.png`;
        list.push(im);
      }
    })();

    // ========================
    // RENDER STATUS (SunCalc if present)
    // ========================
    function renderStatus(){
      const now = new Date();
      let illum, phaseName, lifeStage, nextEvent, waxing, phase01;
    
      if (window.SunCalc){
        const m = SunCalc.getMoonIllumination(now);    // m.fraction (0..1), m.phase (0..1)
        phase01 = m.phase; // 0=new, .25=first quarter, .5=full, .75=last quarter
        illum = m.fraction;
        const deg = m.phase * 360;
    
        // NEW: waxing/waning flag from SunCalc (0..0.5 = waxing, 0.5..1 = waning)
        waxing = (m.phase < 0.5);
    
        // Labels
        phaseName = (deg<1||deg>=359)?'New Moon'
          : deg<45?'Waxing Crescent'
          : deg<90?'First Quarter'
          : deg<135?'Waxing Gibbous'
          : deg<181?'Full Moon'
          : deg<225?'Waning Gibbous'
          : deg<270?'Last Quarter'
          : 'Waning Crescent';
    
        lifeStage = (deg>=45&&deg<180)?'Advance'
          : (deg>=175&&deg<=185)?'Celebrate'
          : (deg>185&&deg<360)?'Recap'
          : 'Wait';
    
        const days = daysUntilNextQuarter(m.phase);
        const when = nextQuarterDate(m.phase, now);
        nextEvent = `${fmtDate(when)}  (in ${days.toFixed(1)} days)`;

    
      } 
    else {
      const info = moonPhase(now);
      ({ illum, phaseName, lifeStage } = info);
    
      // crude phase estimate if SunCalc isn't available
      phase01 = illum;                       // symmetric base
      if (lifeStage === 'Recap') phase01 = 1 - illum;  // flip on waning side
    
      // (your existing nextEvent code continues‚Ä¶)
      let approxPhase = phase01;
      const days = daysUntilNextQuarter(approxPhase);
      const when = nextQuarterDate(approxPhase, now);
      nextEvent = `${fmtDate(when)}  (in ${days.toFixed(1)} days)`;
    
      waxing = (lifeStage === 'Wait' || lifeStage === 'Advance' || lifeStage === 'Celebrate');
    }

    
    // Paint UI
    document.getElementById('todayStr').textContent = fmtDate(now);
    document.getElementById('tzStr').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local time';
    document.getElementById('phaseName').textContent = phaseName;
    document.getElementById('illumPct').textContent = Math.round(illum*100)+'%';
    document.getElementById('lifeStage').textContent = lifeStage;
    document.getElementById('nextEvent').textContent = nextEvent;
    
    // NEW: rotate the ring & mark current phase automatically
    const phaseNum = autoPhaseFromLifeStage(lifeStage);
    setPhase(phaseNum);
    
        // Show PNG moon art
        const artEl = document.getElementById('moonArt');
        if (artEl){
          const idx = artIndexFromPhase(phase01);
          artEl.src = `${MOON_ART_PATH}moon${idx}.png`;
          artEl.alt = `Moon art frame ${idx}`;
        }


    }

    
    // ========================
    // HYDRATE + LISTENERS (after DOM ready)
    // ========================
    function hydrate(){
      // restore inputs/UI
      const j = document.getElementById('journalInput');
      if (j) j.value = state.journal||'';
        renderChecklist();
        renderCarryOver();
        renderLoose();
        renderPurposeList();
        renderTaskList();
        updateMyPurposeBanner();

    
      if (state.journalSavedAt){
        const el = document.getElementById('journalSaved');
        if (el) el.textContent = 'Last saved ' + new Date(state.journalSavedAt).toLocaleString();
      }
      if (j){
        let t;
        j.addEventListener('input', ()=>{ clearTimeout(t); t = setTimeout(()=>saveJournal(), 600); });
      }
    }

    
    //Phase planner
    function showPhase(n){
      // Hide all tagged sections except chosen
      document.querySelectorAll('[data-phase]').forEach(sec=>{
        if (Number(sec.getAttribute('data-phase')) === n) {
          sec.classList.remove('hidden');
        } else {
          sec.classList.add('hidden');
        }
      });
      // Remember choice
      state.activePhase = n; saveState(state);
    }
    
    function autoPhaseFromLifeStage(lifeStage){
      // Map your life stages ‚Üí 1..4
      if (lifeStage === 'Wait') return 1;
      if (lifeStage === 'Advance') return 2;
      if (lifeStage === 'Celebrate') return 3;
      if (lifeStage === 'Recap') return 4;
      return 1;
    }


    // Map life stage -> phase number (we already used this idea)
    function autoPhaseFromLifeStage(lifeStage){
      if (lifeStage === 'Wait') return 1;
      if (lifeStage === 'Advance') return 2;
      if (lifeStage === 'Celebrate') return 3;
      if (lifeStage === 'Recap') return 4;
      return 1;
    }
    
    // Rotate the ring so the selected phase is at the top
    function rotateRingForPhase(n){
      // New base: 2‚Üítop (0deg), 3‚Üí-90deg, 4‚Üí-180deg, 1‚Üí-270deg
      const angles = { 1: -270, 2: 0, 3: -90, 4: -180 };
      const angle = angles[n] ?? 0;
      document.documentElement.style.setProperty('--ring-rot', angle + 'deg');
    }

    // Visually mark which section is current (no hiding)
    function markCurrent(n){
      // highlight the matching section
      document.querySelectorAll('[data-phase]').forEach(sec=>{
        sec.classList.toggle('is-current', Number(sec.getAttribute('data-phase')) === n);
      });
    
      // hide all badges, then show only the one for this phase
      document.querySelectorAll('[data-phase-badge]').forEach(b=> b.style.display = 'none');
      const badge = document.querySelector(`[data-phase-badge="${n}"]`);
      if (badge) badge.style.display = 'inline-block';
    }

    
    // Set phase from user action or URL hash
    function setPhase(n){
      rotateRingForPhase(n);
      markCurrent(n);
      state.activePhase = n;
      saveState(state);
      // No hash push here ‚Äî the router controls the hash
    }

    
    // Read URL hash (#phase=1..4)
    function phaseFromHash(){
      const m = (location.hash || '').match(/phase=(\d)/);
      const n = m ? parseInt(m[1], 10) : NaN;
      return (n>=1 && n<=4) ? n : null;
    }

    // ---- World map (Gall‚ÄìPeters) ----
    async function renderWorldMap(){
      const svg = d3.select("#worldMap");
      if (svg.empty()) return;
    
      const w = svg.node().clientWidth || 800;
      const h = parseInt(svg.style("height")) || 420;
      svg.attr("viewBox", `0 0 ${w} ${h}`);
    
      // Projection
      let projection;
      if (d3.geoCylindricalEqualArea) {
        projection = d3.geoCylindricalEqualArea().parallel(Math.PI / 4);
      } else {
        projection = d3.geoEqualEarth();
      }
      projection.translate([w/2, h/2]).scale(Math.min(w, h) * 0.47);
      const path = d3.geoPath(projection);
    
      // Clip to sphere
      svg.append("defs").append("clipPath")
        .attr("id", "clipSphere")
        .append("path")
        .datum({type: "Sphere"})
        .attr("d", path);
    
      // Base layers
      svg.append("rect").attr("width", w).attr("height", h).attr("class", "map-water");
      const g = svg.append("g");
    
      // Graticule
      const graticule = d3.geoGraticule();
      g.append("path").attr("d", path(graticule())).attr("class","map-lines");
      g.append("path").attr("d", path(d3.geoGraticule().outline())).attr("class","map-border");
    
      // Land + countries
      const landTopo = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json").then(r=>r.json());
      const land = topojson.feature(landTopo, landTopo.objects.land);
      g.append("path").attr("d", path(land)).attr("class","map-land");
    
      const cTopo = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(r=>r.json());
      const countries = topojson.mesh(cTopo, cTopo.objects.countries, (a,b)=>a!==b);
      g.append("path").attr("d", path(countries)).attr("class","map-country");
      
    // Build one or two pixel-space rectangles for a lon/lat box.
    // This sidesteps spherical winding/antimeridian issues entirely.
    function rectPath([lonMin, lonMax, latMin, latMax]) {
      const eps = 1e-6;
      const parts = [];
    
      // split if the box crosses the dateline
      if (lonMin > lonMax) {
        parts.push([lonMin, 180 - eps, latMin, latMax]);
        parts.push([-180 + eps, lonMax,  latMin, latMax]);
      } else {
        parts.push([lonMin, lonMax, latMin, latMax]);
      }
    
      // project corners and make simple screen-space rectangles
      return parts.map(([a,b,c,d])=>{
        const p1 = projection([a, c]); // SW
        const p2 = projection([b, c]); // SE
        const p3 = projection([b, d]); // NE
        const p4 = projection([a, d]); // NW
        return `M${p1[0]},${p1[1]}L${p2[0]},${p2[1]}L${p3[0]},${p3[1]}L${p4[0]},${p4[1]}Z`;
      }).join(' ');
    }

    
      // ---- Regions ----
      const regionGroup = g.append("g").attr("clip-path", "url(#clipSphere)");
    
      const regions = [
        { id:1,  name:"North America",                        box:[-170,-50, 10, 75] },
        { id:2,  name:"Central America & Caribbean",          box:[-105,-60,  5, 25] },
        { id:3,  name:"South America",                        box:[ -82,-35,-56, 13] },
        { id:4,  name:"Europe",                               box:[ -12,  60, 35, 72] },
        { id:5,  name:"Middle East & North Africa",           box:[ -17,  60, 15, 40] },
        { id:6,  name:"Africa ‚Äì Sub-Saharan",                 box:[ -20,  52,-35, 15] },
        { id:7,  name:"Asia ‚Äì Temperate / Steppe / Highland", box:[  40, 140,  5, 60] },
        { id:8,  name:"Asia ‚Äì Monsoon / Maritime",            box:[  65, 145,-10, 35] },
        { id:9,  name:"Oceania & Pacific (West)",             box:[ 110, 180,-25, 20] },
        { id:10, name:"Oceania & Pacific (East)",             box:[-180,-140,-25, 15] },
      ];

        const countEl = document.getElementById('regionCount');
        if (countEl) countEl.textContent = regions.length;   
    
      const colors = ["#8BB8FF","#9FE0D4","#F7C07B","#E59BCC","#9AD07A",
                      "#F18F8B","#C7B7FF","#FFD08A","#8BC6C6","#A5B4FC"];
                      
        // Replace your boxPoly with this:
        function boxPoly([lonMin, lonMax, latMin, latMax]){
          const eps = 1e-6;
        
          // Clamp to < ¬±180 and > ‚àì180 so we never hit the exact meridian
          lonMin = Math.max(lonMin, -180 + eps);
          lonMax = Math.min(lonMax,  180 - eps);
        
          // If a rectangle ever crosses the dateline (lonMin > lonMax), split it
          if (lonMin > lonMax){
            const leftRing = [
              [lonMin, latMin], [180 - eps, latMin],
              [180 - eps, latMax], [lonMin, latMax],
              [lonMin, latMin]
            ];
            const rightRing = [
              [-180 + eps, latMin], [lonMax, latMin],
              [lonMax, latMax], [-180 + eps, latMax],
              [-180 + eps, latMin]
            ];
            return {
              type: "Feature",
              geometry: { type: "MultiPolygon", coordinates: [ [leftRing], [rightRing] ] }
            };
          }
        
          const ring = [
            [lonMin, latMin], [lonMax, latMin],
            [lonMax, latMax], [lonMin, latMax],
            [lonMin, latMin]
          ];
          return { type: "Feature", geometry: { type: "Polygon", coordinates: [ring] } };
        }

        regions.forEach((r,i)=>{
          const dRect = rectPath(r.box);
        
          // visible fill
          regionGroup.append("path")
            .attr("d", dRect)
            .attr("class","map-region")
            .attr("fill", colors[i % colors.length])
            .attr("fill-opacity", .14)
            .attr("data-name", r.name);
        
          // hit area
          regionGroup.append("path")
            .attr("d", dRect)
            .attr("class","map-hit")
            .attr("fill-rule","evenodd")     // extra safety
            .style("pointer-events","all")   // ensure the path is hittable
            .on("mouseenter", function(){
              d3.select(this.previousSibling).attr("fill-opacity", .28);
              showLegendHighlight(r.name);
            })
            .on("mouseleave", function(){
              d3.select(this.previousSibling).attr("fill-opacity", .14);
              showLegendHighlight(null);
            })
            .on("click", ()=> alert("Open region: " + r.name));
        });

    
      // Legend
      const legend = d3.select("#regionLegend");
      if (!legend.empty()){
        legend.selectAll("li").data(regions).enter().append("li")
          .html((r,i)=>`
            <span style="display:inline-block;width:.9rem;height:.9rem;border-radius:9999px;margin-right:.35rem;background:${colors[i%colors.length]}"></span>${r.name}
          `)
          .attr("data-name", d=>d.name);
      }
      
      function showLegendHighlight(name){
        legend.selectAll("li").style("opacity", d=>!name || d.name===name ? 1 : 0.5);
      }
    }


    window.addEventListener('DOMContentLoaded', async ()=>{
      renderStatus();
      route();
      hydrate();
      await loadDraft();             // NEW
      await refreshCurrentCycleUI(); // NEW
      await rebuildCosmicBackground();
      setInterval(renderStatus, 60*1000);
    });

    
    window.addEventListener('hashchange', route);

    // Re-render responsive backgrounds on resize
    window.addEventListener('resize', ()=>{
      // Phase 4 loom art
      const p4 = document.getElementById('page-phase-4');
      if (p4 && p4.classList.contains('active')){
        renderLoomBackground();
      }
      // Cosmic words layer (full-page)
      if (typeof rebuildCosmicBackground === 'function'){
        rebuildCosmicBackground();
      }
    });


    </script>
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>

</body>
</html>
